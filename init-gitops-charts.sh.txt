#!/usr/bin/env bash
set -euo pipefail

# ==============================================================================
# init-gitops-charts.sh
# ==============================================================================
# Objectif:
#   Initialiser (ou ré-initialiser) les charts Helm d'un repo GitOps en local.
#   - Conserve le dossier de VALUES (par env/app) tel quel.
#   - (Optionnel) supprime et recrée le dossier de CHARTS (--force).
#
# Charts générés (par défaut):
#   - quarkus-ms-base : chart générique microservices (Quarkus-ready)
#   - backstage       : chart Backstage (ConfigMap app-config + refs secrets)
#
# Exemple:
#   ./init-gitops-charts.sh --repo-root /path/to/gitops \
#     --values-dir platform-gitops/sfs-microservices \
#     --charts-dir charts --force
#
# Dry run:
#   ./init-gitops-charts.sh --repo-root . --force --dry-run
# ==============================================================================

print_help() {
  cat <<'EOF'
Usage:
  init-gitops-charts.sh [options]

Options:
  --repo-root <path>    Chemin du repo GitOps local (défaut: .)
  --values-dir <path>   Dossier values à CONSERVER (défaut: platform-gitops/sfs-microservices)
  --charts-dir <path>   Dossier charts à (re)créer (défaut: charts)
  --charts <csv>        Charts à générer (défaut: quarkus-ms-base,backstage)
  --force               Supprime entièrement le dossier charts avant génération
  --dry-run             Affiche les actions sans écrire de fichiers
  -h, --help            Aide

Garanties:
  - Le dossier values n'est JAMAIS supprimé.
  - Avec --force, seul le dossier charts est purgé.

EOF
}

REPO_ROOT="."
VALUES_DIR="platform-gitops/sfs-microservices"
CHARTS_DIR="charts"
CHARTS_CSV="quarkus-ms-base,backstage"
FORCE="false"
DRY_RUN="false"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo-root)  REPO_ROOT="${2:-}"; shift 2 ;;
    --values-dir) VALUES_DIR="${2:-}"; shift 2 ;;
    --charts-dir) CHARTS_DIR="${2:-}"; shift 2 ;;
    --charts)     CHARTS_CSV="${2:-}"; shift 2 ;;
    --force)      FORCE="true"; shift ;;
    --dry-run)    DRY_RUN="true"; shift ;;
    -h|--help)    print_help; exit 0 ;;
    *) echo "Unknown arg: $1"; print_help; exit 1 ;;
  esac
done

# Portable-ish absolute path:
# - prefer realpath, fallback to python3, fallback to pwd+relative
abspath() {
  local p="$1"
  if command -v realpath >/dev/null 2>&1; then
    realpath "$p"
  elif command -v python3 >/dev/null 2>&1; then
    python3 - <<PY
import os, sys
print(os.path.abspath(sys.argv[1]))
PY
  else
    (cd "$(dirname "$p")" && printf "%s/%s\n" "$(pwd -P)" "$(basename "$p")")
  fi
}

REPO_ROOT_ABS="$(abspath "$REPO_ROOT")"
CHARTS_PATH="$REPO_ROOT_ABS/$CHARTS_DIR"
VALUES_PATH="$REPO_ROOT_ABS/$VALUES_DIR"

log()  { printf "\033[1;34m[INFO]\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m[WARN]\033[0m %s\n" "$*"; }
err()  { printf "\033[1;31m[ERR ]\033[0m %s\n" "$*"; }

run() {
  if [[ "$DRY_RUN" == "true" ]]; then
    echo "[dry-run] $*"
  else
    eval "$@"
  fi
}

ensure_dir() { run "mkdir -p \"$1\""; }

write_file_stdin() {
  local file="$1"
  if [[ "$DRY_RUN" == "true" ]]; then
    echo "[dry-run] write $file"
    cat >/dev/null
    return 0
  fi
  mkdir -p "$(dirname "$file")"
  cat > "$file"
}

# ------------------------------------------------------------------------------
# Checks
# ------------------------------------------------------------------------------
if [[ ! -d "$REPO_ROOT_ABS" ]]; then
  err "Repo root introuvable: $REPO_ROOT_ABS"
  exit 1
fi

if [[ ! -d "$VALUES_PATH" ]]; then
  warn "Values dir introuvable, création (mais pas suppression): $VALUES_PATH"
  ensure_dir "$VALUES_PATH"
else
  log "Values dir conservé: $VALUES_PATH"
fi

if [[ "$FORCE" == "true" && -d "$CHARTS_PATH" ]]; then
  log "Purge charts dir (--force): $CHARTS_PATH"
  run "rm -rf \"$CHARTS_PATH\""
fi
ensure_dir "$CHARTS_PATH"

IFS=',' read -r -a CHARTS <<< "$CHARTS_CSV"

# ------------------------------------------------------------------------------
# Chart: quarkus-ms-base
# ------------------------------------------------------------------------------
gen_quarkus_ms_base() {
  local dir="$CHARTS_PATH/quarkus-ms-base"
  ensure_dir "$dir/templates"

  cat <<'EOF' | write_file_stdin "$dir/Chart.yaml"
apiVersion: v2
name: quarkus-ms-base
description: Generic Helm chart for Quarkus microservices (Deployment/Service/Ingress, config, envFrom refs).
type: application
version: 0.1.0
appVersion: "1.0.0"
EOF

  cat <<'EOF' | write_file_stdin "$dir/values.yaml"
nameOverride: ""
fullnameOverride: ""

image:
  repository: ""
  tag: ""
  pullPolicy: IfNotPresent
  pullSecrets: []   # ex: ["regcred"]

replicaCount: 1

service:
  type: ClusterIP
  port: 8080
  targetPort: 8080

ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts: []
  tls: []

resources:
  requests: { cpu: 100m, memory: 256Mi }
  limits:   { cpu: 500m, memory: 512Mi }

# Non secret env vars
env: {}

# References to existing ConfigMaps/Secrets (recommended for secrets)
envFrom:
  configMaps: []
  secrets: []

# Optional ConfigMap rendered by the chart
config:
  enabled: false
  name: ""
  data: {}

podAnnotations: {}
podLabels: {}

podSecurityContext: {}
securityContext:
  runAsNonRoot: true
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop: ["ALL"]

volumes: []
volumeMounts: []

probes:
  startup:   { enabled: true, path: /q/health/ready, initialDelaySeconds: 10, periodSeconds: 5,  failureThreshold: 30 }
  readiness: { enabled: true, path: /q/health/ready, initialDelaySeconds: 5,  periodSeconds: 10, failureThreshold: 3 }
  liveness:  { enabled: true, path: /q/health/live,  initialDelaySeconds: 15, periodSeconds: 20, failureThreshold: 3 }
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/_helpers.tpl"
{{- define "quarkus-ms-base.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "quarkus-ms-base.fullname" -}}
{{- if .Values.fullnameOverride -}}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- include "quarkus-ms-base.name" . | trunc 63 | trimSuffix "-" -}}
{{- end -}}
{{- end -}}

{{- define "quarkus-ms-base.labels" -}}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
app.kubernetes.io/name: {{ include "quarkus-ms-base.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end -}}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/configmap.yaml"
{{- if .Values.config.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ default (printf "%s-config" (include "quarkus-ms-base.fullname" .)) .Values.config.name }}
  labels:
    {{- include "quarkus-ms-base.labels" . | nindent 4 }}
data:
{{- range $k, $v := .Values.config.data }}
  {{ $k }}: {{ $v | quote }}
{{- end }}
{{- end }}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/service.yaml"
apiVersion: v1
kind: Service
metadata:
  name: {{ include "quarkus-ms-base.fullname" . }}
  labels:
    {{- include "quarkus-ms-base.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - name: http
      port: {{ .Values.service.port }}
      targetPort: {{ .Values.service.targetPort }}
      protocol: TCP
  selector:
    app.kubernetes.io/name: {{ include "quarkus-ms-base.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/deployment.yaml"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "quarkus-ms-base.fullname" . }}
  labels:
    {{- include "quarkus-ms-base.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "quarkus-ms-base.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "quarkus-ms-base.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        {{- with .Values.podLabels }}{{- toYaml . | nindent 8 }}{{- end }}
      annotations:
        {{- with .Values.podAnnotations }}{{- toYaml . | nindent 8 }}{{- end }}
    spec:
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.image.pullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: app
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort }}
          env:
            {{- range $k, $v := .Values.env }}
            - name: {{ $k }}
              value: {{ $v | quote }}
            {{- end }}
          {{- if or .Values.envFrom.configMaps .Values.envFrom.secrets .Values.config.enabled }}
          envFrom:
            {{- if .Values.config.enabled }}
            - configMapRef:
                name: {{ default (printf "%s-config" (include "quarkus-ms-base.fullname" .)) .Values.config.name }}
            {{- end }}
            {{- range .Values.envFrom.configMaps }}
            - configMapRef: { name: {{ . }} }
            {{- end }}
            {{- range .Values.envFrom.secrets }}
            - secretRef: { name: {{ . }} }
            {{- end }}
          {{- end }}
          {{- if .Values.probes.startup.enabled }}
          startupProbe:
            httpGet: { path: {{ .Values.probes.startup.path }}, port: http }
            initialDelaySeconds: {{ .Values.probes.startup.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.startup.periodSeconds }}
            failureThreshold: {{ .Values.probes.startup.failureThreshold }}
          {{- end }}
          {{- if .Values.probes.readiness.enabled }}
          readinessProbe:
            httpGet: { path: {{ .Values.probes.readiness.path }}, port: http }
            initialDelaySeconds: {{ .Values.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.readiness.periodSeconds }}
            failureThreshold: {{ .Values.probes.readiness.failureThreshold }}
          {{- end }}
          {{- if .Values.probes.liveness.enabled }}
          livenessProbe:
            httpGet: { path: {{ .Values.probes.liveness.path }}, port: http }
            initialDelaySeconds: {{ .Values.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.liveness.periodSeconds }}
            failureThreshold: {{ .Values.probes.liveness.failureThreshold }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          {{- with .Values.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/ingress.yaml"
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "quarkus-ms-base.fullname" . }}
  labels:
    {{- include "quarkus-ms-base.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations: {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  rules:
  {{- range .Values.ingress.hosts }}
    - host: {{ .host }}
      http:
        paths:
        {{- range .paths }}
          - path: {{ .path }}
            pathType: {{ .pathType }}
            backend:
              service:
                name: {{ include "quarkus-ms-base.fullname" $ }}
                port: { number: {{ $.Values.service.port }} }
        {{- end }}
  {{- end }}
  {{- if .Values.ingress.tls }}
  tls: {{- toYaml .Values.ingress.tls | nindent 4 }}
  {{- end }}
{{- end }}
EOF

  cat <<EOF | write_file_stdin "$dir/README.md"
# quarkus-ms-base

Chart générique pour microservices Quarkus.

## Render (exemple)
\`\`\`bash
helm template my-ms ./${CHARTS_DIR}/quarkus-ms-base -f ${VALUES_DIR}/development/my-ms.yaml
\`\`\`

## Notes
- Secrets: utiliser envFrom.secrets (Secrets existants) plutôt que des secrets en clair dans values.
- Probes: /q/health/ready et /q/health/live.
EOF
}

# ------------------------------------------------------------------------------
# Chart: backstage
# ------------------------------------------------------------------------------
gen_backstage() {
  local dir="$CHARTS_PATH/backstage"
  ensure_dir "$dir/templates"

  cat <<'EOF' | write_file_stdin "$dir/Chart.yaml"
apiVersion: v2
name: backstage
description: Backstage chart (ConfigMap app-config + envFrom refs + ingress).
type: application
version: 0.1.0
appVersion: "1.0.0"
EOF

  cat <<'EOF' | write_file_stdin "$dir/values.yaml"
nameOverride: ""
fullnameOverride: ""

image:
  repository: ""
  tag: ""
  pullPolicy: IfNotPresent
  pullSecrets: []

replicaCount: 1

service:
  type: ClusterIP
  port: 7007
  targetPort: 7007

ingress:
  enabled: false
  className: ""
  annotations: {}
  host: ""
  path: /
  pathType: Prefix
  tls:
    enabled: false
    secretName: ""

resources:
  requests: { cpu: 200m, memory: 512Mi }
  limits:   { cpu: 1000m, memory: 2Gi }

podSecurityContext: {}
securityContext:
  runAsNonRoot: true
  allowPrivilegeEscalation: false

# Backstage app-config.yaml rendered as ConfigMap and mounted to /app/app-config.yaml
appConfig:
  enabled: true
  fileName: app-config.yaml
  data: |
    app:
      title: Backstage
      baseUrl: http://localhost:7007
    backend:
      baseUrl: http://localhost:7007
      listen:
        port: 7007

extraEnv: {}

envFrom:
  configMaps: []
  secrets: []

volumes: []
volumeMounts: []

probes:
  readiness: { enabled: true, path: /healthcheck, initialDelaySeconds: 10, periodSeconds: 10, failureThreshold: 6 }
  liveness:  { enabled: true, path: /healthcheck, initialDelaySeconds: 30, periodSeconds: 20, failureThreshold: 3 }
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/_helpers.tpl"
{{- define "backstage.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{- define "backstage.fullname" -}}
{{- if .Values.fullnameOverride -}}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- include "backstage.name" . | trunc 63 | trimSuffix "-" -}}
{{- end -}}
{{- end -}}

{{- define "backstage.labels" -}}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
app.kubernetes.io/name: {{ include "backstage.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end -}}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/configmap.yaml"
{{- if .Values.appConfig.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "backstage.fullname" . }}-config
  labels:
    {{- include "backstage.labels" . | nindent 4 }}
data:
  {{ .Values.appConfig.fileName }}: |
{{ .Values.appConfig.data | indent 4 }}
{{- end }}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/service.yaml"
apiVersion: v1
kind: Service
metadata:
  name: {{ include "backstage.fullname" . }}
  labels:
    {{- include "backstage.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - name: http
      port: {{ .Values.service.port }}
      targetPort: {{ .Values.service.targetPort }}
      protocol: TCP
  selector:
    app.kubernetes.io/name: {{ include "backstage.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/deployment.yaml"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "backstage.fullname" . }}
  labels:
    {{- include "backstage.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "backstage.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "backstage.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.image.pullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: backstage
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort }}
          env:
            {{- range $k, $v := .Values.extraEnv }}
            - name: {{ $k }}
              value: {{ $v | quote }}
            {{- end }}
          {{- if or .Values.envFrom.configMaps .Values.envFrom.secrets }}
          envFrom:
            {{- range .Values.envFrom.configMaps }}
            - configMapRef: { name: {{ . }} }
            {{- end }}
            {{- range .Values.envFrom.secrets }}
            - secretRef: { name: {{ . }} }
            {{- end }}
          {{- end }}
          volumeMounts:
            {{- if .Values.appConfig.enabled }}
            - name: app-config
              mountPath: /app/app-config.yaml
              subPath: {{ .Values.appConfig.fileName }}
              readOnly: true
            {{- end }}
            {{- with .Values.volumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- if .Values.probes.readiness.enabled }}
          readinessProbe:
            httpGet: { path: {{ .Values.probes.readiness.path }}, port: http }
            initialDelaySeconds: {{ .Values.probes.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.readiness.periodSeconds }}
            failureThreshold: {{ .Values.probes.readiness.failureThreshold }}
          {{- end }}
          {{- if .Values.probes.liveness.enabled }}
          livenessProbe:
            httpGet: { path: {{ .Values.probes.liveness.path }}, port: http }
            initialDelaySeconds: {{ .Values.probes.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.probes.liveness.periodSeconds }}
            failureThreshold: {{ .Values.probes.liveness.failureThreshold }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      volumes:
        {{- if .Values.appConfig.enabled }}
        - name: app-config
          configMap:
            name: {{ include "backstage.fullname" . }}-config
        {{- end }}
        {{- with .Values.volumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
EOF

  cat <<'EOF' | write_file_stdin "$dir/templates/ingress.yaml"
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "backstage.fullname" . }}
  labels:
    {{- include "backstage.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations: {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  rules:
    - host: {{ .Values.ingress.host }}
      http:
        paths:
          - path: {{ .Values.ingress.path }}
            pathType: {{ .Values.ingress.pathType }}
            backend:
              service:
                name: {{ include "backstage.fullname" . }}
                port: { number: {{ .Values.service.port }} }
  {{- if .Values.ingress.tls.enabled }}
  tls:
    - secretName: {{ .Values.ingress.tls.secretName }}
      hosts: [ {{ .Values.ingress.host }} ]
  {{- end }}
{{- end }}
EOF

  cat <<EOF | write_file_stdin "$dir/README.md"
# backstage

Chart Backstage (ConfigMap app-config + envFrom refs + ingress).

## Render (exemple)
\`\`\`bash
helm template portail-rosetta ./${CHARTS_DIR}/backstage -f ${VALUES_DIR}/development/portail-rosetta.yaml
\`\`\`

## Notes
- Secrets: toujours via envFrom.secrets (Secrets existants / ExternalSecrets / Vault).
- app-config: injecté via ConfigMap et monté en fichier.
EOF
}

# ------------------------------------------------------------------------------
# Generate requested charts
# ------------------------------------------------------------------------------
for c in "${CHARTS[@]}"; do
  case "$c" in
    quarkus-ms-base) log "Generate chart: quarkus-ms-base"; gen_quarkus_ms_base ;;
    backstage)       log "Generate chart: backstage";       gen_backstage ;;
    *) warn "Chart inconnu ignoré: $c" ;;
  esac
done

log "OK: charts générés dans: $CHARTS_PATH"
log "OK: values conservés dans: $VALUES_PATH"
